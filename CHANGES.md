# 差込機能改善 - 変更内容まとめ

## 変更ファイル一覧

1. **types.ts** - 差込列の定義を追加
2. **App.tsx** - 差込処理ロジックとUIを大幅改善
3. **vite-env.d.ts** - 新規作成（環境変数の型定義）

## 主な変更内容

### 1. types.ts
- `MERGE_FIELD_NAMES` 定数を追加（指定された9列を定義）
- `MergeRow` 型に `Date` 型を追加（日付処理対応）

### 2. App.tsx
- **カーソル位置挿入機能 (`insertAtCursor`)**: 件名・本文のカーソル位置にプレースホルダーを挿入
- **日付フォーマット処理 (`formatDateValue`)**: Excelの日付セルをISO形式（YYYY-MM-DD）に変換
- **動的タグ置換 (`replaceMergeTags`)**: テンプレート内の全タグを動的に探索して置換、未定義タグを警告
- **Excel読み取り改善**: ヘッダー行を正確に読み取り、日付列を自動識別・フォーマット
- **Excel優先ロジック**: 日付１、日付２、予備１、予備２はExcelから読み込むが、なければ手入力欄から取得
- **ツールバー追加 (`id="merge-toolbar"`)**: 指定順序（メールアドレス→会社名→...→予備２）でボタン配置
- **プレビュー機能**: 1行目のデータで件名・本文の差込プレビューを表示
- **未定義タグ警告**: 差込処理時に未定義タグを検出して警告表示

### 3. vite-env.d.ts（新規作成）
- `import.meta.env.VITE_GOOGLE_CLIENT_ID` の型定義を追加

## 要件対応状況

✅ A. 指定された9列（メールアドレス、会社名、担当者名、案件名、URL、日付１、日付２、予備１、予備２）を日本語ヘッダー名で完全一致で検出・差込
✅ B. 既存コードの差込できない列を修正して差込可能に
✅ C. ツールバー（id="merge-toolbar"）を追加し、指定順序でボタン配置
✅ D. Excelからの自動差込を優先（日付１、日付２、予備１、予備２）
✅ E. Excel読み取りロジックでヘッダー行をキーにしたオブジェクト形式でアクセス可能
✅ F. 動的タグ探索による置換処理を実装、未定義タグは警告表示
✅ G. OAuth/Gmail APIロジックは変更なし（差込内容の置換後にdraft作成）

## 動作確認手順

### 1. ローカル環境での起動
```bash
cd d:\gmail-draft-helper
npm install  # 依存関係が未インストールの場合
npm run dev
```

ブラウザで `http://localhost:3000` にアクセス

### 2. Excelファイルの準備
以下のヘッダーを含むExcelファイル（.xlsx）を用意:
- メールアドレス（必須）
- 会社名
- 担当者名
- 案件名
- URL
- 日付１（日付型または文字列）
- 日付２（日付型または文字列）
- 予備１
- 予備２

### 3. 動作確認項目

#### 3.1 Excelファイルアップロード
1. 「Excel差込作成 (個別送信)」タブを選択
2. Excelファイルをアップロード
3. 読み込み成功メッセージと、読み込まれた列のボタンが表示されることを確認

#### 3.2 ツールバーの動作確認
1. 「差込項目クイック挿入ツールバー」セクションを確認
2. 指定順序（メールアドレス→会社名→...→予備２）でボタンが並んでいることを確認
3. 各項目について「件名:」と「本文:」の2つのボタンがあることを確認
4. 件名入力欄にフォーカスを当て、「件名: {会社名}」ボタンをクリック
   → カーソル位置に `{会社名}` が挿入されることを確認
5. 本文入力欄にフォーカスを当て、「本文: {担当者名}」ボタンをクリック
   → カーソル位置に `{担当者名}` が挿入されることを確認

#### 3.3 差込プレビュー機能
1. Excelファイルをアップロード後、件名・本文に差込タグを入力（例: `{会社名}様 お見積りの件`）
2. 件名・本文入力欄の下にプレビューが表示されることを確認
3. 1行目のデータで差込が正しく表示されることを確認

#### 3.4 Excel優先ロジック確認
1. Excelファイルに「日付１」列を含むデータを用意
2. ファイルをアップロード
3. 「共通差込項目」の「日付１」入力欄に、Excelの値が自動で設定されることを確認
4. Excelに「日付１」列がない場合は、手動で値を入力できることを確認

#### 3.5 未定義タグ警告
1. 本文に存在しないタグ（例: `{存在しない列}`）を入力
2. 「下書きを作成」ボタンをクリック
3. 処理ログに「警告: 以下のタグが定義されていません: {存在しない列}」が表示されることを確認

#### 3.6 差込処理実行
1. 有効なExcelファイルと件名・本文を入力
2. 「下書きを作成」ボタンをクリック（Google認証が必要な場合は認証を完了）
3. 各データ行に対して下書きが作成されることを確認
4. Gmailの下書きフォルダに、正しく差込が反映された下書きが作成されることを確認

## 設計上の懸念事項

1. **URL長の制限**: Gmail APIのURL長制限（約2000文字）を超える可能性は低いが、長い本文の場合は注意が必要
2. **件数制限**: Gmail APIのレート制限（1分あたり250リクエスト）により、大量の行がある場合は処理時間がかかる
3. **日付のローカルフォーマット**: 現在はISO形式（YYYY-MM-DD）で統一していますが、日本形式（YYYY年MM月DD日）への変換はクライアント側で手動入力が必要
4. **全角・半角の違い**: 「日付１」と「日付1」など、全角・半角の違いに対応していますが、Excelファイルのヘッダーは統一することを推奨
5. **エラーハンドリング**: ネットワークエラーやAPI制限エラーが発生した場合、該当行はスキップされて処理が継続します

## 改善提案

1. **バッチ処理**: 大量データの場合は、複数のリクエストに分割してバッチ処理する機能
2. **日付フォーマットのカスタマイズ**: ユーザーが希望する日付フォーマットを選択できる機能
3. **CSV対応の強化**: 現在は.xlsxのみ対応だが、CSVのエンコーディング検出を改善
4. **プレビュー行の選択**: 現在は1行目のみだが、任意の行を選択してプレビューできる機能
